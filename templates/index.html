{{define "index"}}
<!DOCTYPE html>
<html lang="{{.Lang}}">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lucas Almeida Dev</title>
	<style>{{.Styles}}</style>
	<style>
		#mobile-menu-btn {
			transition: .2s ease;
		}
		#menu-overlay {
			display: none;
			width: 100vw;
			height: 100vh;
			background-color: transparent;
			position: fixed;
			top: 0; left: 0;
			z-index: 999;
			transition: .3s ease;
		}
		#menu-overlay > div {
			opacity: 0;
			transition: .3s ease;
		}
		#menu-overlay #close-overlay-btn {
			position: fixed;
			top: 25px;
			right: 15px;
			z-index: 1000;
			width: 30px;
			height: 30px;
			cursor: pointer;
			display: flex;
			justify-content: center;
			align-items: center;
			opacity: 0;
			transition: .3s ease;
		}
		#menu-overlay #close-overlay-btn::after {
			content: '';
			position: absolute;
			display: block;
			width: 35px;
			height: 3px;
			border-radius: 1.25rem;
			rotate: 45deg;
			background-color: #ff7809;
		}
		#menu-overlay #close-overlay-btn::before {
			content: '';
			position: absolute;
			display: block;
			width: 35px;
			height: 3px;
			border-radius: 1.25rem;
			rotate: -45deg;
			background-color: #ff7809;
		}
		.fade-in {
			transition: 1s ease;
			translate: 0 30px;
			opacity: .33;
		}
	</style>
	<script>{{.HTMX}}</script>
	<script>
		const url = window.location.href
		const queryParams = new URLSearchParams(url.split('?')[1])
		const mode = queryParams.get('visualmode')
		const lang = queryParams.get('lang')
		if (!mode) {
			const savedMode = localStorage.getItem('visualmode')
			if (savedMode) {
				if (!['dark', 'light'].includes(savedMode)) {
					localStorage.setItem('visualmode', 'dark')
					savedMode = 'dark'
				}
				queryParams.set('visualmode', savedMode)
				window.location.href = '?' + queryParams.toString()
			} else {
				localStorage.setItem('visualmode', 'dark')
				queryParams.set('visualmode', 'dark')
				window.location.href = '?' + queryParams.toString()
			}
		}
		if (!lang) {
			const savedLang = localStorage.getItem('lang')
			if (savedLang) {
				if (!['en', 'pt'].includes(savedLang)) {
					localStorage.setItem('lang', 'en')
					savedLang = 'en'
				}
				queryParams.set('lang', savedLang)
				window.location.href = '?' + queryParams.toString()
			} else {
				localStorage.setItem('lang', 'en')
				queryParams.set('lang', 'en')
				window.location.href = '?' + queryParams.toString()
			}
		}
	</script>
</head>

<body
class="
{{if .IsDarkmode}}
	text-gray-100 bg-gray-800
{{else}}
	text-gray-700 bg-gray-100
{{end}}
leading-none font-mono">
	{{template "header" .}}
	<div id="menu-overlay">
		<button id="close-overlay-btn"></button>
		<div
		class="w-full h-full flex flex-col justify-start items-center
		pt-8 pb-4 px-4">
			<div
			class="w-full
			flex flex-row justify-start pl-4 space-x-3">
				<button id="toggle-visualmode-btn-mobile" style="width: 40px; height: 40px">
					<img style="width: 100%;" src="{{if .IsDarkmode}}{{.IMG_moon}}{{else}}{{.IMG_orange_sun}}{{end}}" alt="">
				</button>
				<button id="toggle-lang-btn-mobile" style="width: 40px; height: 40px" class="rounded-full">
					<img style="width: 100%;" src="{{if eq .Lang "en"}}{{.IMG_en}}{{else}}{{.IMG_pt}}{{end}}" alt="">
				</button>
			</div>
		</div>
	</div>
	<div id="mobile-menu"></div>
	<main class="w-full flex flex-col items-center justify-center px-4 md:px-2 lg:px-0">
		{{template "hero" .}}
	</main>
</body>
<script>
	;(() => {
		const mobileMenuBtn = document.getElementById('mobile-menu-btn')
		const menuOverlay = document.getElementById('menu-overlay')
		const menuOverlayDivChildren = menuOverlay.querySelectorAll('div')
		const closeOverlayBtn = document.getElementById('close-overlay-btn')
		const toggleThemeBtn = document.getElementById('toggle-visualmode-btn')
		const toggleLangBtn = document.getElementById('toggle-lang-btn')
		const toggleThemeBtnMobile = document.getElementById('toggle-visualmode-btn-mobile')
		const toggleLangBtnMobile = document.getElementById('toggle-lang-btn-mobile')
		if (!mobileMenuBtn) {
			return console.error('mobile menu not found')
		}
		if (!menuOverlay) {
			return console.error('menu overlay not found')
		}
		if (!closeOverlayBtn) {
			return console.error('close overlay button not found')
		}
		if (!toggleThemeBtn) {
			return console.error('toggle theme button not found')
		}

		const toggleTheme = () => {
			if (queryParams.get('visualmode') === 'dark') {
				queryParams.set('visualmode', 'light')
			} else {
				queryParams.set('visualmode', 'dark')
			}
			window.location.href = '?' + queryParams.toString()
		}
		const toggleLang = () => {
			if (queryParams.get('lang') === 'en') {
				queryParams.set('lang', 'pt')
			} else {
				queryParams.set('lang', 'en')
			}
			window.location.href = '?' + queryParams.toString()
		}
		toggleThemeBtn.addEventListener('click', toggleTheme)
		toggleLangBtn.addEventListener('click', toggleLang)
		toggleThemeBtnMobile.addEventListener('click', () => {
			toggleTheme()
			hideMenu()
		})
		toggleLangBtnMobile.addEventListener('click', () => {
			toggleLang()
			hideMenu()
		})

		let isShowingMobileMenu = false
		mobileMenuBtn.addEventListener('click', () => {
			isShowingMobileMenu = !isShowingMobileMenu
			if (isShowingMobileMenu) {
				showMenu()
			} else {
				hideMenu()
			}
		})
		closeOverlayBtn.addEventListener('click', () => {
			hideMenu()
		})

		function hideMenu() {
			isShowingMobileMenu = false
			menuOverlay.style.background = 'transparent'
			closeOverlayBtn.style.opacity = '0'
			for (const el of menuOverlayDivChildren) {
				el.style.opacity = '0'
			}
			setTimeout(() => {
				mobileMenuBtn.style.opacity = '1'
			}, 50)
			setTimeout(() => {
				menuOverlay.style.display = 'none';
			}, 300)
		}
		function showMenu() {
			menuOverlay.style.display = 'block';
			mobileMenuBtn.style.opacity = '0'
			setTimeout(() => {
				menuOverlay.style.background = mode === 'dark' ? 'linear-gradient(#00102aba, #00000090)' : 'linear-gradient(#00101dd0, #000000c0)'
				closeOverlayBtn.style.opacity = '1'
				for (const el of menuOverlayDivChildren) {
					el.style.opacity = '1'
				}
			}, 10)
		}

		const toBeAnimated = document.querySelectorAll('.fade-in')
		if (!toBeAnimated) {
			return console.error('no elements to be animated')
		}
		function throttle(mainFunction, delay) {
			let timerFlag = null;
			return (...args) => {
				if (timerFlag === null) {
					mainFunction(...args);
						timerFlag = setTimeout(() => {
						timerFlag = null;
					}, delay);
				}
			};
		}
		const createDetector = (controller) => {
			let prev = false;
			return () => {
				for (const el of toBeAnimated) {
					const rect = el.getBoundingClientRect()
					const elTop = rect.top + window.scrollY
					const elBottom = rect.bottom + window.scrollY
					const scrollTop = window.scrollY + window.innerHeight - Math.floor(rect.height / 2)
					const isOnScreen = scrollTop >= elTop && scrollTop <= elBottom + window.innerHeight
					setTimeout(() => prev = isOnScreen, 40)
					if (isOnScreen && !prev) {
						console.log('entered', el, {elTop, elBottom, scrollTop, h: window.innerHeight})
						controller.entered(el)
					}
					if (prev && !isOnScreen) {
						console.log('left',  el, {elTop, elBottom, scrollTop, h: window.innerHeight})
						controller.left(el)
					}
				}
			}
		}

		const createController = () => {
			const animating = []
			let timeout;
			return {
				entered: (el) => {
					if (!animating.includes(el)) {
						animating.push(el)
						el.style.opacity = '1'
						el.style.translate = '0 0'
						timeout = setTimeout(() => animating.splice(animating.indexOf(el), 1), 1000)
					} else {
						// clearTimeout(timeout)
						// isAnimating = true
						// el.style.opacity = '1'
						// el.style.translate = '0 40px'
						// timeout = setTimeout(() => isAnimating = false, 300)
					}
				},
				left: (el) => {
					if (animating.includes(el)) {
						animating.push(el)
						el.style.opacity = '0'
						el.style.translate = '0 30px'
						timeout = setTimeout(() => animating.splice(animating.indexOf(el), 1), 1000)
					} else {
						// clearTimeout(timeout)
						// isAnimating = true
						// el.style.opacity = '0'
						// el.style.translate = '0 0'
						// timeout = setTimeout(() => isAnimating = false, 300)
					}
				}
			}
		}

		const onScreenDetection = createDetector(createController())
		setTimeout(onScreenDetection, 100)
		window.addEventListener('scroll', throttle(onScreenDetection, 50))
	})()
	// const modeSwitch = document.getElementById('mode-switch')
	// if (modeSwitch) {
	// 	modeSwitch.addEventListener('click', () => {
	// 		const visualMode = queryParams.get('visualmode')
	// 		if (!visualMode) {
	// 			localStorage.setItem('visualmode', 'dark')
	// 			queryParams.set('visualmode', 'dark')
	// 			window.location.href = '?' + queryParams.toString()
	// 			return
	// 		} else if (visualMode === 'dark') {
	// 			localStorage.setItem('visualmode', 'light')
	// 			queryParams.set('visualmode', 'light')
	// 			window.location.href = '?' + queryParams.toString()
	// 		} else {
	// 			localStorage.setItem('visualmode', 'dark')
	// 			queryParams.set('visualmode', 'dark')
	// 			window.location.href = '?' + queryParams.toString()
	// 		}
	// 	})
	// }
</script>
</html>
{{end}}